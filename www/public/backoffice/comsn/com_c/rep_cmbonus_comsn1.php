<?include("rpdialog.php");$fmcode = $_POST['fmcode']==""?$_GET['fmcode']:$_POST['fmcode'];$fdate = $_POST['fdate']==""?$_GET['fdate']:$_POST['fdate'];$tdate = $_POST['tdate']==""?$_GET['tdate']:$_POST['tdate'];$type_report = $_POST['type_report']==""?$_GET['type_report']:$_POST['type_report'];$bonus = $_POST['bonus']==""?$_GET['bonus']:$_POST['bonus'];?><script language="javascript" type="text/javascript">	function sale_print(id){		var wlink = 'tax_print_member.php?bid='+id;		//var wlink = 'invoice_aprint_sale.php?bid='+id;		//var wlink = 'http://yourbizasia.tua-lek.com/billprint.aspx?sano='+id;		window.open(wlink);		//window.location.reload();		//window.location='index.php?sessiontab=7&sub=282828&sanoo='+id;	}	function sale_look(id){		//var wlink = 'tax_print_member.php?bid='+id;		var wlink = 'invoice_alook_sale.php?bid='+id;		//var wlink = 'http://yourbizasia.tua-lek.com/billprint.aspx?sano='+id;		window.open(wlink);		//window.location.reload();		//window.location='index.php?sessiontab=3&sub=6&sanooo='+id;	}	function sale_cancel(id){		if(confirm("ต้องการยกเลิกบิลนี้")){			window.location='index.php?sessiontab=3&sub=6&state=3&bid='+id;		}	}	function sale_status(id,page){	//	if(confirm("ต้องการเปลี่ยนแปลงการรับของ")){			window.location='index.php?sessiontab=3&sub=6&state=6&sender='+id+'&page='+page;	//	}	}		function sale_status1(id,page){	//	if(confirm("ต้องการเปลี่ยนแปลงจัดส่ง")){			window.location='index.php?sessiontab=3&sub=6&state=7&sender='+id+'&page='+page;	//	}	}</script><?if (strpos($bonus,"-")===false){		$arr_bonus[0]=$bonus;		$arr_bonus[1]=$bonus;}else{	$arr_bonus = explode('-',$bonus);}if($arr_bonus[0] > $arr_bonus[1]){   echo "<center><FONT COLOR=#ff0000>กรุณากรอกช่วงร่ายได้ให้ถูก เช่น 0-500</FONT></center>";}if($fdate!=""){	$sql="select min(rcode) as fdate1,max(rcode) as tdate1 from ".$dbprefix."cround a where a.fdate >= '".$fdate."' and a.tdate <= '".$tdate."' ";	$result=mysql_query($sql);	if (mysql_num_rows($result)>'0') {		$row= mysql_fetch_array($result, MYSQL_ASSOC);		$ftrc2[0]=$row["fdate1"];		$ftrc2[1]=$row["tdate1"];		}}$ftrcode = $_POST['ftrcode']==""?$_GET['ftrcode']:$_POST['ftrcode'];$ftrcode2 = $_POST['ftrcode2']==""?$_GET['ftrcode2']:$_POST['ftrcode2'];$vip = $_POST['vip']==""?$_GET['vip']:$_POST['vip'];if (strpos($ftrcode,"-")===false){		//รอบเริ่มต้น == รอบสิ้นสุด		$ftrc[0]=$ftrcode;		$ftrc[1]=$ftrcode;}else{	$ftrc = explode('-',$ftrcode);}rpdialog_alls($_GET['sub'],$fdate,$tdate);require("connectmysql.php");$wwhere = ($fdate[0]=="" ? " a.rcode between '".$ftrc[0]."' and '".$ftrc[1]."' " : " a.paydate >= '".$fdate."' and a.paydate <= '".$tdate."' and  a.status = 1 ");$wwhere1 = " a.total between '".$arr_bonus[0]."' and '".$arr_bonus[1]."' ";//echo $wwhere;if($fdate != ''){		if (isset($_GET["pg"])){$page=$_GET["pg"];} else {$page="1";}		if($_GET['state']==1){		include("comsn/com_c/rep_change.php");		}		$sql = "SELECT m.acc_no,m.bankcode";		$sql .= ",a.id,a.rcode,a.mcode,m.name_t,a.pv,a.pvb,a.tot_tax,SUM(a.totaly) as total1,m.id_card  ";		$sql .= ",CONCAT(address,' ',zip) AS address ";		$sql .= "FROM ".$dbprefix."cmbonus a ";		$sql .= " LEFT JOIN ".$dbprefix."member m ON a.mcode=m.mcode ";			$sql .= " WHERE $wwhere ";		$sql .= "GROUP BY a.mcode";		if($fmcode != '' )$sql .= " and a.mcode = ".$fmcode."";		if($_POST['bonus'] != '' )$sql .= " and a.total between '".$arr_bonus[0]."' and '".$arr_bonus[1]."' ";		if($type_report == 1 )$sql .= " ";		if($type_report == 2 )$sql .= " and m.mtype2 = '1' ";		if($type_report == 3 )$sql .= " and m.bankcode = '52'";		if($type_report == 4 )$sql .= " and m.bankcode != '52'";		if($type_report == 5 )$sql .= " and m.bankcode != '52' and m.mtype2 != '1' ";						$rec = new repGenerator_b();		$rec->setQuery($sql);		$rec->setSort(($_GET['srt']==""?"UP":$_GET['srt']));		$rec->setOrder(($_GET['ord']==""?"a.rcode":$_GET['ord']));		if($_GET['excel']==1){$rec->setLimitPage("ALL");}		else{$rec->setLimitPage("100");}		$rec->setSize("100%","");		$rec->setAlign("center");		$rec->setPageLinkAlign("right");		$rec->setLink($PHP_SELF,"sessiontab=".$sesstab."&sub=".$_GET["sub"]."&ftrcode=$ftrcode&ftrcode2=$ftrcode2&fdate=$fdate&tdate=$tdate&strfdate=$strfdate&strtdate=$strtdate&fmcode=$fmcode&bonus=$bonus&type_report=$type_report");		$rec->setBackLink($PHP_SELF,"sessiontab=".$sesstab."");		if(isset($page))			$rec->setCurPage($page);		//$rec->setShowIndex(true);		$rec->setShowField("mcode,name_t,address,id_card,total1");		$rec->setFieldDesc("รหัส,ชื่อ,ที่อยู่,เลขที่บัตรประชาชน,จำนวนรวมโบนัส");		$rec->setFieldAlign("center,left,left,center,right");		$rec->setFieldSpace("10%,15%,50%,10%,10%");//10		$rec->setSum(true,false,",,,,true");		//$rec->setFieldFloatFormat(",,,2,2,2,2,2,2");		$rec->setSpecial("./images/Amber-Printer.gif","","sale_print","mcode","IMAGE","หนังสือรับรอง");		if($acc->isAccess(4)){		//	$rec->setDel("index.php","id","id","sessiontab=4&sub=2828");		//	$rec->setFromDelAttr("maindel","./index.php?sessiontab=4&sub=2828&state=1&ftrcode=$ftrcode&fmcode=$fmcode","post","delfield");		}/*		if(isset($_POST['skey']))			$rec->setCause($_POST['skey'],$_POST['scause']);		else if(isset($_GET['skey']))			$rec->setCause($_GET['skey'],$_GET['scause']);		$rec->setSearch("a.mcode");		$rec->setSearchDesc("รหัส");*/		$rec->setSpecial("","","","","NUMROW","ลำดับ");		$rec->setFieldLink("");		if($_GET['excel']==1){			$rec->exportXls("ExportXls","packfile100".date("Ymd").".xls","SH_QUERY");			$str = "<fieldset><a href='".$rec->download("ExportXls","packfile100".date("Ymd").".xls")."' >";			$str .= "<img border='0' src='./images/download.gif'>โหลด Excel</a></fieldset>";			//$rec->getParam();			$rec->setSpace($str);		}		//$str = "<fieldset><a href='".$rec->getParam()."&excel=1' target='_self'>";		//$str .= "<img border='0' src='./images/excel.gif'>สร้าง Excel</a></fieldset>";				//$rec->setSpace($str);		$str1 = "<fieldset ><a href='tax_print_member1.php?fdate=$fdate&tdate=$tdate' target='_blank'>";		$str1 .= "<img border='0' src='./images/Amber-Printer.gif'>พิมพ์ทั้งหมด(ภงด.1)</a></fieldset>";		$rec->setSpace($str1);				$str2 = "<fieldset ><a href='tax_print_member2.php?fdate=$fdate&tdate=$tdate' target='_blank'>";		$str2 .= "<img border='0' src='./images/Amber-Printer.gif'>พิมพ์ทั้งหมด(ภงด.1ก)</a></fieldset>";		$rec->setSpace($str2);				$str3 = "<fieldset ><a href='tax_print_member.php?fdate=$fdate&tdate=$tdate' target='_blank'>";		$str3 .= "<img border='0' src='./images/Amber-Printer.gif'>พิมพ์ทั้งหมด(หนังสือรับรองการหักภาษี ณ ที่จ่าย)</a></fieldset>";		$rec->setSpace($str3);												$rec->showRec(1,'SH_QUERY');		mysql_close($link);	}			function cal_tax($total){	$sumtotal = $total;	$sumtax = 0;		$exp11 = array('4000000'=>4000000,					'2000000'=>2000000,					'1000000'=>1000000,					'750000'=>750000,					'500000'=>500000,					'300000'=>300000,					'150000'=>150000,					'0'=> ''			 				);  					foreach(array_keys($exp11) as $key){			if($sumtotal>=$exp11[$key]){ $pos_new = $key; break;}	}	//echo $sumtotal.'<br>';	//echo $pos_new.'<br>';		$sss = $sumtotal-$pos_new.'<br>';	$exp = array('4000000'=>0.35,				'2000000'=>0.30,				'1000000'=>0.25,				'750000'=>0.20,				'500000'=>0.15,				'300000'=>0.10,				'150000'=>0.05,				'0'=> ''				);  			$exp1 = array('4000000'=>965000,				'2000000'=>365000,				'1000000'=>115000,				'750000'=>65000,				'500000'=>27500,				'300000'=>7500,				'150000'=>0,				'0'=> ''				);  	//echo $exp[$pos_new].'<br>';	$sumtax = $sss*$exp[$pos_new]+$exp1[$pos_new];		RETURN 	$sumtax;}?>